#!/usr/bin/env python3
"""Simula um ataque e verifica o registro no painel web."""
import os
import time
import json
import urllib.request

UNIT_PORT = int(os.getenv("UNIT_PORT", "8090"))
WEB_PANEL_PORT = int(os.getenv("WEB_PANEL_PORT", "8080"))


def send_request(payload: str) -> None:
    url = f"http://localhost:{UNIT_PORT}/?data={payload}"
    try:
        with urllib.request.urlopen(url, timeout=5) as resp:
            resp.read()
        print(f"Requisição enviada para {url}")
    except Exception as exc:
        print(f"Falha ao enviar requisição: {exc}")


def fetch_json(path: str):
    url = f"http://localhost:{WEB_PANEL_PORT}{path}"
    try:
        with urllib.request.urlopen(url, timeout=5) as resp:
            return json.loads(resp.read().decode())
    except Exception as exc:
        print(f"Falha ao acessar {url}: {exc}")
        return None


def main() -> None:
    payload = "<script>alert('ataque')</script>"
    send_request(payload)
    time.sleep(2)  # aguarda processamento do log
    logs = fetch_json("/api/logs")
    if logs is None:
        print("Proxy ou painel web parece inativo.")
        return
    if any(payload in entry.get('log', '') for entry in logs):
        print("Payload encontrado nos logs.")
    else:
        print("Payload NÃO encontrado nos logs.")

    blocked = fetch_json("/api/blocked")
    if blocked is None:
        print("Não foi possível obter a lista de IPs bloqueados.")
        return
    if blocked:
        print("IPs bloqueados:")
        for item in blocked:
            print(f"- {item['ip']} ({item['reason']}) [{item['status']}]")
    else:
        print("Nenhum IP bloqueado.")


if __name__ == "__main__":
    main()
