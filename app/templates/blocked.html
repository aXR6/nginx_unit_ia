{% extends 'base.html' %}

{% block content %}
<div id="blocked-app" v-cloak>
  <h1 class="display-5 mb-4 text-center">IPs Bloqueados</h1>
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-primary">
            <tr>
              <th>IP</th>
              <th>Status</th>
              <th>Motivo</th>
              <th>Data/Hora</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="item in blocked" :key="item.ip + item.blocked_at">
              <td>{{ item.ip }}</td>
              <td :class="statusClass(item.status)">{{ item.status }}</td>
              <td>{{ item.reason or '' }}</td>
              <td>{{ item.blocked_at }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center p-2">
        <button @click="fetchBlocked(page-1)" :disabled="page === 1" class="btn btn-sm btn-secondary">Anterior</button>
        <span class="fw-bold">Página {{ page }}</span>
        <button @click="fetchBlocked(page+1)" class="btn btn-sm btn-secondary">Próxima</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const BlockedApp = {
    data() {
        return { blocked: [], page: {{ page }}, evt: null };
    },
    methods: {
        statusClass(status) {
            return status === 'blocked' ? 'status-blocked' : 'status-unblocked';
        },
        async fetchBlocked(page) {
            if (page < 1) return;
            const res = await fetch(`/api/blocked?page=${page}`);
            this.blocked = await res.json();
            this.page = page;
            if (this.evt) this.evt.close();
            if (page === 1) {
                this.evt = new EventSource('/stream/blocked');
                this.evt.onmessage = (e) => {
                    const item = JSON.parse(e.data);
                    this.blocked.unshift(item);
                };
            }
        },
    },
    mounted() {
        this.fetchBlocked(this.page);
    },
    beforeUnmount() {
        if (this.evt) this.evt.close();
    }
};

Vue.createApp(BlockedApp).mount('#blocked-app');
</script>
{% endblock %}
