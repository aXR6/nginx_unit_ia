{% extends 'base.html' %}

{% block content %}
<div id="logs-app" v-cloak>
  <h1 class="display-5 mb-4 text-center">Logs</h1>
  <div class="card">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-striped table-hover align-middle">
          <thead class="table-primary">
            <tr>
              <th>Timestamp</th>
              <th>Interface</th>
              <th>IP</th>
              <th>Tipo Ataque</th>
              <th>Intensidade</th>
              <th>Log</th>
              <th>Severity</th>
              <th>Anomaly</th>
              <th>Ação</th>
              <th>Inesperado</th>
              <th>Modelos</th>
            </tr>
          </thead>
          <tbody>
            <tr v-for="log in logs" :key="log.id">
              <td>{{ log.created_at }}</td>
              <td>{{ log.iface }}</td>
              <td :title="ipInfo(log)">{{ log.ip || '' }}</td>
              <td>{{ log.attack_type || log.nids.label }}</td>
              <td>{{ log.intensity }}</td>
              <td class="log-cell">
                <a :href="'/log/' + log.id" class="text-decoration-none">{{ abbreviate(log.log) }}</a>
              </td>
              <td :class="severityClass(log.severity.label)" :title="log.severity.model">{{ log.severity.label }}</td>
              <td :title="log.anomaly.model">{{ log.anomaly.label }}</td>
              <td>
                <span class="category-label" :style="categoryStyle(log.nids.label)" :title="log.nids.model">
                  {{ log.nids.label }}
                </span>
              </td>
              <td>{{ log.semantic.outlier ? 'sim' : 'não' }}</td>
              <td>{{ modelInfo(log) }}</td>
            </tr>
          </tbody>
        </table>
      </div>
      <div class="d-flex justify-content-between align-items-center p-2">
        <button @click="fetchLogs(page - 1)" :disabled="page === 1" class="btn btn-sm btn-secondary">Anterior</button>
        <span class="fw-bold">Página {{ page }}</span>
        <button @click="fetchLogs(page + 1)" class="btn btn-sm btn-secondary">Próxima</button>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
const LogsApp = {
    data() {
        return { logs: [], page: {{ page }}, evt: null };
    },
    methods: {
        categoryColor(cat) {
            let hash = 0;
            for (let i = 0; i < cat.length; i++) {
                hash = cat.charCodeAt(i) + ((hash << 5) - hash);
            }
            const hue = Math.abs(hash) % 360;
            return `hsl(${hue},70%,80%)`;
        },
        categoryStyle(cat) {
            return { backgroundColor: this.categoryColor(cat) };
        },
        severityClass(label) {
            if (!label) return '';
            const l = label.toLowerCase();
            if (l === 'high' || l === 'error') return 'severity-high';
            if (l === 'medium' || l === 'warning') return 'severity-medium';
            return 'severity-low';
        },
        abbreviate(text, len = 60) {
            return text.length > len ? text.slice(0, len) + '...' : text;
        },
        modelInfo(log) {
            return `S:${log.severity.model} A:${log.anomaly.model} N:${log.nids.model}`;
        },
        ipInfo(log) {
            return log.ip_info ? `${log.ip_info.city || ''}, ${log.ip_info.country || ''}` : '';
        },
        async fetchLogs(page) {
            if (page < 1) return;
            const res = await fetch(`/api/logs?page=${page}`);
            this.logs = await res.json();
            this.page = page;
            if (this.evt) this.evt.close();
            if (page === 1) {
                this.evt = new EventSource('/stream/logs');
                this.evt.onmessage = (e) => {
                    const log = JSON.parse(e.data);
                    this.logs.unshift(log);
                };
            }
        },
    },
    mounted() {
        this.fetchLogs(this.page);
    },
    beforeUnmount() {
        if (this.evt) this.evt.close();
    }
};

Vue.createApp(LogsApp).mount('#logs-app');
</script>
{% endblock %}
